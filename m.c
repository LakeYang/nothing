#include <stc12c5a60s2.H>    
#include <INTRINS.H>    

sbit Beep =  P1^5;
sbit Btn = P1^1;
   
unsigned char n=0;

/*
Pitch Map:
1Do:0x5B 91 *
2Re:0x54 84 *
3Mi:0x4d 77 *
4Fa:0x47 71 *
5So:0x41 65 *
6La:0x3B 59 *
7Xi:0x35 53 *
---
1Do:0x30 48
2Re:0x2B 43
3Mi:0x26 38
4Fa:0x22 34 *
5So:0x20 32
6La:0x1C 28
7Xi:0x1A 26 *
---
1Do:0x18 24
2Re:0x15 21
3Mi:0x13 19 *
*/
/*
Length:
0x80 : 2 Note
0x40 : Full Note
0x20 : 1/2 Note
*/
unsigned char code music_tab[] ={
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x10,
0x30,0x10,
0x2B,0x10,
0x26,0x10,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x20,
0x41,0x40,
0x3B,0x20,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x10,
0x30,0x10,
0x2B,0x10,
0x26,0x10,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x20,
0x22,0x40,
0x26,0x20,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x10,
0x30,0x10,
0x2B,0x10,
0x26,0x10,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x20,
0x41,0x40,
0x3B,0x20,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x35,
0xff,0x05,
0x3B,0x10,
0x30,0x10,
0x2B,0x10,
0x26,0x10,
0x1C,0x60,
0x20,0x15,
0xff,0x05,
0x20,0x20,
0x1C,0x50,
0xff,0x50
};
unsigned char code music_tabs[] ={
0x3b,0x20,
0x35,0x20,
0x30,0x60,
0x35,0x20,
0x30,0x40,
0x26,0x40,
0x35,0x80,
0xff,0x40,
0x4d,0x40,
0x3B,0x60,
0x41,0x20,
0x3B,0x40,
0x30,0x40,
0x41,0x80,
0xff,0x40,
0x4d,0x40,
0x47,0x60,
0x4d,0x20,
0x47,0x40,
0x30,0x40,
0x4d,0x80,
0xff,0x40,
0x30,0x40,
0x35,0x60,
0x47,0x60,
0x35,0xC0,
0xff,0x40,
0x3b,0x20,
0x35,0x20,
0x30,0x60,
0x35,0x20,
0x30,0x40,
0x26,0x40,
0x35,0x80,
0xff,0x40,
0x4d,0x40,
0x3B,0x60,
0x41,0x20,
0x3B,0x40,
0x30,0x40,
0x41,0x80,
0xff,0x40,
0x54,0x20,
0x4d,0x20,
0x47,0x40,
0x30,0x20,
0x35,0x60,
0x30,0x30,
0x2B,0x70,
0x26,0x20,
0x30,0x90,
0x35,0x20,
0x3B,0x40,
0x35,0x40,
0x41,0x40,
0x3B,0x80,
0xff,0x40,
0x30,0x20,
0x2B,0x20,
0x26,0x60,
0x2B,0x10,
0x26,0x40,
0x20,0x40,
0x2B,0xC0,
0xff,0x40,
0x30,0x60,
0x35,0x20,
0x30,0x40,
0x26,0xC0,
0x26,0x40,
0xff,0x40,
0x3B,0x20,
0x35,0x20,
0x30,0x40,
0x35,0x20,
0x30,0x20,
0x2B,0x40,
0x30,0x60,
0x41,0xA0,
0x22,0x40,
0x26,0x40,
0x2B,0x40,
0x30,0x20,
0x26,0xE0,
0xff,0x10,
0x26,0x30,
0x1C,0x80,
0x20,0x80,
0x26,0x20,
0x2B,0x20,
0x30,0xC0,
0x2B,0x60,
0x30,0x20,
0x2B,0x40,
0x20,0x40,
0x26,0xC0,
0xff,0x10,
0x26,0x30,
0x1C,0x80,
0x20,0x80,
0x26,0x20,
0x2B,0x20,
0x30,0xC0,
0x2B,0x60,
0x30,0x20,
0x2B,0x40,
0x35,0x30,
0x3B,0x90,
0xff,0x40,
0x00
};

unsigned char PL(char m)
{
	switch(m)
	{
	//Do:
		case 0x5b: P2=0x7f; break;
		case 0x30: P2=0x7f; break;
	//Re:
		case 0x54: P2=0xbf; break;
		case 0x2b: P2=0xbf; break;
	//Mi:
		case 0x4d: P2=0xdf; break;
		case 0x26: P2=0xdf; break;
	//Fa:
		case 0x47: P2=0xef; break;
		case 0x22: P2=0xef; break;
	//So:
		case 0x41: P2=0xf7; break;
		case 0x20: P2=0xf7; break;
	//La:
		case 0x3b: P2=0xfb; break;
		case 0x1c: P2=0xfb; break;
	//Xi:
		case 0x35: P2=0xfd; break;
		case 0x1a: P2=0xfd; break;
		default: P2=0xff; break;
	}
}
void int0()  interrupt 1  
{
	TH0=0xd8;   
	TL0=0xef;   
	n--;   
}   
   
void delay (unsigned char m)
{   
	unsigned i=3*m;   
	while(--i);   
}   
   
void delayms(unsigned char a) 
{   
	while(--a);
}   
   
void main()   
{ 
	unsigned char p,m;  
	unsigned char i=0;   
	unsigned char lastStat=0;
	unsigned char ifPaused=0;
	TMOD&=0x0f;
	TMOD|=0x01;
	TH0=0xd8;
	TL0=0xef;
	IE=0x82;

	P2=0x00;
	while(1)   
	{
		if(Btn){
			if(lastStat==0){
				lastStat=1;
				ifPaused=~ifPaused;
			}
		}else{
			lastStat=0;
		}
		if(ifPaused){
			continue;
		}
		p=music_tab[i];   
		if(p==0x00)       
		{ 
			i=0;
			n=0x40;
			TR0=1;
			while(n!=0)
			{
				delay(100);
			}  
			TR0=0;
			continue;
		}         
		else if(p==0xff)  
		{
			i=i+1;
			Beep=0;
			PL(0xff);
			n=music_tab[i++];
			TR0=1;
			while(n!=0)
			{
				delay(100);
			}  
			TR0=0;
			continue;
		} 
		else         
		{
			m=music_tab[i++];
			n=music_tab[i++];
		}    
		PL(m);
		TR0=1;
		while(n!=0)
		{
			Beep=~Beep;
			delay(m);
		}  
		TR0=0;
	}   
}
